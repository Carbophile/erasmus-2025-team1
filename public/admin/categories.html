<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuizBattle Admin - Categories</title>
  <link rel="stylesheet" href="../admin/css/general.css" />
  <link rel="stylesheet" href="../admin/css/questions.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
</head>
<body>
<aside class="sidebar">
  <div class="logo">QuizBattle</div>
  <nav>
    <a href="/admin/users"><i class="fa-solid fa-users"></i><span>Users</span></a>
    <a href="/admin/questions"><i class="fa-solid fa-question"></i><span>Questions</span></a>
    <a href="/admin/quizzes"><i class="fa-solid fa-file-circle-question"></i><span>Quizzes</span></a>
    <a href="/admin/categories" class="active"><i class="fa-solid fa-icons"></i><span>Categories</span></a>
  </nav>
</aside>

<div class="main">
  <header class="topbar">
    <div class="nav-left">
      <a href="../index.html"><button class="btn">Home</button></a>
      <a href="../leadeboard/lista.html"><button class="btn">Leaderboard</button></a>
    </div>
    <div class="search-box">
      <input type="text" placeholder="Search..." />
      <i class="fa fa-search"></i>
    </div>
    <div class="nav-right">
      <a href="../profil/profil.html"><i class="fa-solid fa-user user-icon"></i></a>
    </div>
  </header>

  <section class="table-section">
    <div class="table-header">
      <h2>Categories</h2>
      <button class="btn add-btn" onclick="openAddForm()"><i class="fa fa-plus"></i> Add</button>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Id</th>
            <th>Name</th>
            <th>Edit</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody id="category-table-body"></tbody>
      </table>
    </div>
  </section>
</div>

<!-- Add Category Overlay -->
<div class="overlay" id="add-category-overlay">
  <div class="card">
    <h3>Add Category</h3>
    <form id="add-category-form">
      <div class="form-group">
        <label>Name</label>
        <input type="text" name="name" required />
      </div>
      <button type="submit" class="submit-btn">Save</button>
    </form>
    <button class="close-btn" onclick="closeOverlay('add-category-overlay')">Close</button>
  </div>
</div>

<!-- Edit Category Overlay -->
<div class="overlay" id="edit-category-overlay">
  <div class="card">
    <h3>Edit Category</h3>
    <form id="edit-category-form">
      <input type="hidden" name="id" />
      <div class="form-group">
        <label>Name</label>
        <input type="text" name="name" required />
      </div>
      <button type="submit" class="submit-btn">Update</button>
    </form>
    <button class="close-btn" onclick="closeOverlay('edit-category-overlay')">Close</button>
  </div>
</div>

<!-- Delete Confirmation Overlay -->
<div class="overlay" id="delete-overlay">
  <div class="card">
    <h3>Delete Category</h3>
    <p>Are you sure you want to delete this category?</p>
    <div class="button-row">
      <button class="cancel-btn" onclick="closeOverlay('delete-overlay')">Cancel</button>
      <button class="confirm-btn" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const token = localStorage.getItem("authToken");
  if (!token) return window.location.href = "../login/index.html";

  async function ensureAdmin() {
    try {
      const res = await fetch('/user/isAdmin', { method: 'POST', headers: { Authorization: `Bearer ${token}` } });
      if (!res.ok) throw new Error();
      const data = await res.json();
      if (!data.success || !data.isAdmin) {
        return window.location.href = '../index.html';
      }
    } catch (_) {
      return window.location.href = '../login/index.html';
    }
  }

  await ensureAdmin();

  const tableBody = document.getElementById("category-table-body");
  let deleteTarget = null;

  async function fetchCategories() {
    try {
      const response = await fetch("/categories", {
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
      });
      const data = await response.json();
      if (data.success) renderTable(data.categories);
      else alert(data.error || "Failed to load categories");
    } catch (err) { console.error(err); }
  }

  function renderTable(categories) {
    tableBody.innerHTML = "";
    categories.forEach(cat => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${cat.id}</td>
        <td>${cat.name}</td>
        <td><button class="icon-btn" onclick='openEditForm(${JSON.stringify(cat)})'><i class="fa fa-pen"></i></button></td>
        <td><button class="icon-btn danger" onclick="openDelete(${cat.id})"><i class="fa fa-trash"></i></button></td>
      `;
      tableBody.appendChild(row);
    });
  }

  window.openAddForm = () => {
    document.getElementById("add-category-form").reset();
    document.getElementById("add-category-overlay").style.display = "flex";
  };

  window.openEditForm = (cat) => {
    const form = document.getElementById("edit-category-form");
    form.reset();
    form.id.value = cat.id;
    form.name.value = cat.name;
    document.getElementById("edit-category-overlay").style.display = "flex";
  };

  window.closeOverlay = (id) => document.getElementById(id).style.display = "none";

  document.getElementById("add-category-form").addEventListener("submit", async e => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target).entries());
    const payload = { name: data.name };
    try {
      const res = await fetch("/quiz/category", {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify(payload)
      });
      const result = await res.json();
      if (result.success) { fetchCategories(); closeOverlay("add-category-overlay"); }
      else alert(result.error || "Add failed");
    } catch (err) { console.error(err); }
  });

  document.getElementById("edit-category-form").addEventListener("submit", async e => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target).entries());
    const payload = { id: data.id, name: data.name };
    try {
      const res = await fetch("/category", {
        method: "PUT",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify(payload)
      });
      const result = await res.json();
      if (result.success) { fetchCategories(); closeOverlay("edit-category-overlay"); }
      else alert(result.error || "Update failed");
    } catch (err) { console.error(err); }
  });

  window.openDelete = id => { deleteTarget = id; document.getElementById("delete-overlay").style.display = "flex"; };
  window.confirmDelete = async () => {
    if (!deleteTarget) return;
    try {
      const res = await fetch("/category", {
        method: "DELETE",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify({ id: deleteTarget })
      });
      const result = await res.json();
      if (result.success) { fetchCategories(); closeOverlay("delete-overlay"); deleteTarget = null; }
      else alert(result.error || "Delete failed");
    } catch (err) { console.error(err); }
  };

  fetchCategories();
});
</script>
</body>
</html>
