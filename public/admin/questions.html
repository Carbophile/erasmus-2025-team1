<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QuizBattle Admin - Questions</title>
  <link rel="stylesheet" href="../admin/css/questions.css" />
  <link rel="stylesheet" href="../admin/css/general.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
</head>
<body>
  <aside class="sidebar">
    <div class="logo">QuizBattle</div>
    <nav>
      <a href="/admin/users"><i class="fa-solid fa-users"></i><span>Users</span></a>
      <a href="/admin/questions" class="active"><i class="fa-solid fa-question"></i><span>Questions</span></a>
      <a href="/admin/quizzes"><i class="fa-solid fa-file-circle-question"></i><span>Quizzes</span></a>
      <a href="/admin/categories"><i class="fa-solid fa-icons"></i><span>Categories</span></a>
    </nav>
  </aside>

  <div class="main">
    <header class="topbar">
      <div class="nav-left">
        <a href="../index.html"><button class="btn">Home</button></a>
        <a href="../leadeboard/lista.html"><button class="btn">Leaderboard</button></a>
      </div>
      <div class="search-box">
        <input type="text" placeholder="Search..." />
        <i class="fa fa-search"></i>
      </div>
      <div class="nav-right">
        <a href="../profil/profil.html"><i class="fa-solid fa-user user-icon"></i></a>
      </div>
    </header>

    <section class="table-section">
      <div class="table-header">
        <h2>Questions</h2>
        <button class="btn add-btn" onclick="openForm()"><i class="fa fa-plus"></i> Add</button>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Id</th>
              <th>Question</th>
              <th>Options</th>
              <th>Category</th>
              <th>Country</th>
              <th>Quiz Id</th>
              <th>Edit</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody id="questions-table-body"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Popup: View answers -->
  <div class="overlay" id="view-overlay">
    <div class="card" id="answer-card">
      <h3>Question</h3>
      <ul class="options-list"></ul>
      <button class="close-btn" onclick="closeOverlay('view-overlay')">Close</button>
    </div>
  </div>

  <!-- Popup: Add/Edit Form -->
  <div class="overlay" id="form-overlay">
    <div class="card">
      <h3 id="form-title">Add Question</h3>
      <form id="question-form">
        <input type="hidden" name="id" />
        <div class="form-group">
          <label>Question</label>
          <input type="text" name="question" required />
        </div>
        <div class="form-group">
          <label>Options (comma separated)</label>
          <input type="text" name="options" required />
        </div>
        <div class="form-group">
          <label>Correct Answers (comma separated)</label>
          <input type="text" name="correct" required />
        </div>
        <div class="form-group">
          <label>Category</label>
          <input type="text" name="category" required />
        </div>
        <div class="form-group">
          <label>Country</label>
          <select name="country" required>
            <option value="0">HR</option>
            <option value="1">NL</option>
          </select>
        </div>
        <div class="form-group">
          <label>Quiz Id</label>
          <input type="number" name="quizId" required />
        </div>
        <button type="submit" class="submit-btn">Save</button>
      </form>
      <button class="close-btn" onclick="closeOverlay('form-overlay')">Close</button>
    </div>
  </div>

  <!-- Popup: Delete Confirmation -->
  <div class="overlay" id="delete-overlay">
    <div class="card">
      <h3 id="delete-title">Delete Question</h3>
      <p id="delete-message">Are you sure you want to delete this question?</p>
      <div class="button-row">
        <button class="cancel-btn" onclick="closeOverlay('delete-overlay')">Cancel</button>
        <button class="confirm-btn" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <script>
    const tableBody = document.getElementById("questions-table-body");
    const formOverlay = document.getElementById("form-overlay");
    const form = document.getElementById("question-form");
    const formTitle = document.getElementById("form-title");
    const submitBtn = form.querySelector(".submit-btn");
    const token = localStorage.getItem("token");
    let allQuestions = [];
    let deleteTarget = null;

    async function fetchQuestions() {
      try {
        const res = await fetch("/questions", {
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        });
        const data = await res.json();
        if (data.success && Array.isArray(data.questions)) {
          allQuestions = data.questions;
          renderTable();
        } else {
          console.error("Unexpected response:", data);
        }
      } catch (err) {
        console.error("Fetch error:", err);
      }
    }

    function renderTable() {
      tableBody.innerHTML = "";

      if (!allQuestions || allQuestions.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#888;">No questions found</td></tr>`;
        return;
      }

      allQuestions.forEach((q) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${q.id}</td>
          <td>${q.text}</td>
          <td><button class="btn small" onclick="showAnswers(${q.id})">Show</button></td>
          <td>${q.category_id ?? "-"}</td>
          <td>${q.country === 0 ? "HR" : q.country === 1 ? "NL" : q.country}</td>
          <td>${q.quiz_id}</td>
          <td><button class="icon-btn" onclick='openForm(${JSON.stringify(q)})'><i class="fa fa-pen"></i></button></td>
          <td><button class="icon-btn danger" onclick="openDelete(${q.id})"><i class="fa fa-trash"></i></button></td>
        `;
        tableBody.appendChild(row);
      });
    }

    // Show options
    async function showAnswers(questionId) {
      try {
        const res = await fetch(`/option?question_id=${questionId}`, {
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        });
        const data = await res.json();
        if (!data || !Array.isArray(data)) {
          alert("Could not load options");
          return;
        }

        const q = allQuestions.find(q => q.id === questionId);
        const card = document.getElementById("answer-card");
        card.querySelector("h3").textContent = q ? q.text : "Question";

        const optionsList = card.querySelector(".options-list");
        optionsList.innerHTML = "";
        data.forEach(opt => {
          const li = document.createElement("li");
          li.textContent = opt.text || opt.option || JSON.stringify(opt);
          if (opt.is_correct) li.classList.add("correct");
          optionsList.appendChild(li);
        });

        document.getElementById("view-overlay").style.display = "flex";
      } catch (err) {
        console.error("Error fetching options:", err);
        alert("Error loading options");
      }
    }

    function openForm(question = null) {
      form.reset();
      if (question) {
        formTitle.textContent = "Edit Question";
        submitBtn.textContent = "Update";
        form.id.value = question.id;
        form.question.value = question.text || "";
        form.options.value = question.options ? question.options.join(", ") : "";
        form.correct.value = question.correct ? question.correct.join(", ") : "";
        form.category.value = question.category_id ?? "";
        form.country.value = question.country ?? 0;
        form.quizId.value = question.quiz_id ?? "";
      } else {
        formTitle.textContent = "Add Question";
        submitBtn.textContent = "Save";
      }
      formOverlay.style.display = "flex";
    }

    function closeOverlay(id) {
      document.getElementById(id).style.display = "none";
    }

    // Add/Edit submit
    form.addEventListener("submit", async e => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form).entries());
      const payload = {
        question: data.question,
        options: data.options.split(",").map(o => o.trim()).filter(Boolean),
        correct: data.correct.split(",").map(o => o.trim()).filter(Boolean),
        category: data.category,
        country: Number(data.country),
        quiz_id: Number(data.quizId),
      };
      try {
        let res;
        if (data.id) {
          payload.id = Number(data.id);
          res = await fetch("/question", {
            method: "PUT",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify(payload),
          });
        } else {
          res = await fetch("/quiz/question", {
            method: "POST",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify(payload),
          });
        }
        const result = await res.json();
        if (result.success) {
          fetchQuestions();
          closeOverlay("form-overlay");
        } else {
          alert(result.error || "Save failed");
        }
      } catch (err) {
        console.error(err);
      }
    });

    function openDelete(id) {
      deleteTarget = id;
      document.getElementById("delete-overlay").style.display = "flex";
    }

    async function confirmDelete() {
      if (!deleteTarget) return;
      try {
        const res = await fetch("/question", {
          method: "DELETE",
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
          body: JSON.stringify({ id: deleteTarget }),
        });
        const result = await res.json();
        if (result.success) {
          allQuestions = allQuestions.filter(q => q.id !== deleteTarget);
          renderTable();
        } else {
          alert(result.error || "Delete failed");
        }
      } catch (err) {
        console.error(err);
      } finally {
        closeOverlay("delete-overlay");
        deleteTarget = null;
      }
    }

    document.addEventListener("DOMContentLoaded", fetchQuestions);
  </script>
</body>
</html>
