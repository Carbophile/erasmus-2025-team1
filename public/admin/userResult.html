<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="../admin/css/general.css" />
		<link rel="stylesheet" href="../admin/css/userResult.css" />
		<link rel="stylesheet" href="../admin/css/users.css" />
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
		/>
		<title>Admin - User Results</title>
	</head>
	<body>
		<aside class="sidebar">
			<div class="logo">QuizBattle</div>
			<nav>
				<a href="/admin/users" class="active"
					><i class="fa-solid fa-users"></i><span>Users</span></a
				>
				<a href="/admin/questions"
					><i class="fa-solid fa-question"></i><span>Questions</span></a
				>
				<a href="/admin/quizzes"
					><i class="fa-solid fa-file-circle-question"></i
					><span>Quizzes</span></a
				>
				<a href="/admin/categories"
					><i class="fa-solid fa-icons"></i><span>Categories</span></a
				>
			</nav>
		</aside>

		<div class="main">
			<header class="topbar">
				<div class="nav-left">
					<a href="../index.html"><button class="btn">Home</button></a>
					<a href="../leadeboard/lista.html"
						><button class="btn">Leaderboard</button></a
					>
				</div>
				<div class="search-box">
					<input type="text" placeholder="Search..." />
					<i class="fa fa-search"></i>
				</div>
				<div class="nav-right">
					<a href="../profil/profil.html"
						><i class="fa-solid fa-user user-icon"></i
					></a>
				</div>
			</header>

			<section class="table-section">
				<div class="table-header">
					<h2 id="results-title">User Results</h2>
				</div>
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Result Id</th>
								<th>Score</th>
								<th>Time Taken</th>
								<th>Quiz Id</th>
								<th>Date</th>
								<th>Delete</th>
							</tr>
						</thead>
						<tbody id="results-table-body">
							<!-- Filled dynamically -->
						</tbody>
					</table>
				</div>
			</section>
		</div>

		<!-- Delete Confirmation Overlay -->
		<div class="overlay" id="delete-overlay" style="display: none">
			<div class="overlay-content">
				<h3>Delete Result</h3>
				<p>Are you sure you want to delete this result?</p>
				<button class="confirm-btn" id="confirm-delete">Delete</button>
				<button class="cancel-btn" id="cancel-delete">Cancel</button>
			</div>
		</div>

		<script>
			document.addEventListener("DOMContentLoaded", async () => {
				const params = new URLSearchParams(window.location.search);
				const userId = params.get("id");
				const resultsTable = document.getElementById("results-table-body");
				const resultsTitle = document.getElementById("results-title");
				const token = localStorage.getItem("token");

				if (!userId) {
					resultsTable.innerHTML = `<tr><td colspan="6" style="text-align:center;">User ID missing</td></tr>`;
					return;
				}

				// Fetch user info
				let userName = `User ${userId}`;
				try {
					const userRes = await fetch(`/user?id=${userId}`, {
						headers: { Authorization: `Bearer ${token}` },
					});
					if (userRes.ok) {
						const userData = await userRes.json();
						userName = userData.name || userName;
					}
				} catch (err) {
					console.error("Error fetching user:", err);
				}
				resultsTitle.textContent = `Results for ${userName}`;

				// Fetch results
				let allResults = [];
				try {
					const res = await fetch(`/result?user_id=${userId}`, {
						headers: { Authorization: `Bearer ${token}` },
					});
					if (!res.ok) throw new Error("Failed to fetch results");
					allResults = await res.json();
				} catch (err) {
					console.error(err);
					resultsTable.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">Error loading results</td></tr>`;
				}

				function renderResults() {
					if (!allResults.length) {
						resultsTable.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#888;">No results found for this user.</td></tr>`;
						return;
					}

					resultsTable.innerHTML = "";
					allResults.forEach((result) => {
						const row = document.createElement("tr");
						row.innerHTML = `
        <td>${result.id}</td>
        <td>${result.score}</td>
        <td>${result.time_taken}</td>
        <td>${result.quiz_id}</td>
        <td>${new Date(result.create_date).toLocaleString()}</td>
        <td><button class="icon-btn danger" onclick="openDeleteOverlay(${
					result.id
				}, this)"><i class="fa fa-trash"></i></button></td>
      `;
						resultsTable.appendChild(row);
					});
				}

				renderResults();

				// Delete overlay logic
				const overlay = document.getElementById("delete-overlay");
				const confirmBtn = document.getElementById("confirm-delete");
				const cancelBtn = document.getElementById("cancel-delete");
				let deleteTarget = null; // {resultId, row}

				window.openDeleteOverlay = (resultId, btn) => {
					deleteTarget = { resultId, row: btn.closest("tr") };
					overlay.style.display = "flex";
				};

				const closeOverlay = () => {
					deleteTarget = null;
					overlay.style.display = "none";
				};

				cancelBtn.addEventListener("click", closeOverlay);

				confirmBtn.addEventListener("click", async () => {
					if (!deleteTarget) return;
					try {
						const res = await fetch("/result", {
							method: "DELETE",
							headers: {
								Authorization: `Bearer ${token}`,
								"Content-Type": "application/json",
							},
							body: JSON.stringify({ id: deleteTarget.resultId }),
						});
						const data = await res.json();
						if (data.success) {
							allResults = allResults.filter(
								(r) => r.id !== deleteTarget.resultId
							);
							deleteTarget.row.remove();
							renderResults();
						} else {
							alert("Delete failed");
						}
					} catch (err) {
						console.error(err);
						alert("Delete failed");
					} finally {
						closeOverlay();
					}
				});
			});
		</script>
		<script src="../components/sidebar.html" type="import"></script>
		<script src="../components/topbar.html" type="import"></script>
		<script type="module" src="../admin/js/components.js"></script>
		<script type="module">
			import { loadComponent } from "../admin/js/components.js";
			loadComponent("sidebar-template", "sidebar-container");
			loadComponent("topbar-template", "topbar-container");
		</script>
	</body>
</html>
