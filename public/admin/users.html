<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>QuizBattle Admin</title>
		<link rel="stylesheet" href="../admin/css/users.css" />
		<link rel="stylesheet" href="../admin/css/general.css" />
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
		/>
   
	</head>
	<body>
		<aside class="sidebar">
			<div class="logo">QuizBattle</div>
			<nav>
				<a href="/admin/users" class="active"
					><i class="fa-solid fa-users"></i><span>Users</span></a
				>
				<a href="/admin/questions"
					><i class="fa-solid fa-question"></i><span>Questions</span></a
				>
			</nav>
		</aside>
     <div class="main">
		<header class="topbar">
				<div class="nav-left">
					<a href="../index.html"><button class="btn" onclick="window.location.href='index.html'">Home</button></a>
					<a href="../leadeboard/lista.html"><button class="btn">Leaderboard</button></a>
				</div>
				<div class="search-box">
					<input type="text" placeholder="Search..." />
					<i class="fa fa-search"></i>
				</div>
				<div class="nav-right">
					<a href="../profil/profil.html"><i class="fa-solid fa-user user-icon"></i></a>
				</div>
			</header>

  <section class="table-section">
    <div class="table-header">
      <h2>Users</h2>
      <button class="btn add-btn" onclick="openForm()"><i class="fa fa-plus"></i> Add</button>
    </div>
    <div class="table-container">
      <table>
        <thead>
        <tr>
          <th>Id</th>
          <th>Name</th>
          <th>Email</th>
          <th>Score</th>
          <th>Results</th>
          <th>Admin</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
        </thead>
        <tbody id="user-table-body"></tbody>
      </table>
    </div>
  </section>
  </div>
</div>
<!-- Popup: Add/Edit User -->
<div class="overlay" id="form-overlay">
  <div class="card">
    <h3 id="form-title">Add User</h3>
    <form id="user-form">
      <input type="hidden" name="id" />
      <div class="form-group">
        <label>Name</label><input type="text" name="name" required />
      </div>
      <div class="form-group">
        <label>Email</label><input type="email" name="email" required />
      </div>
      <div class="form-group">
        <label>Score</label><input type="number" name="score" required />
      </div>
      <div class="form-group">
        <label>Admin</label>
        <select name="admin">
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>
      </div>
      <button type="submit" class="submit-btn">Save</button>
    </form>
    <button class="close-btn" onclick="closeOverlay('form-overlay')">Close</button>
  </div>
</div>
<!-- Popup: Delete Confirmation -->
<div class="overlay" id="delete-overlay">
  <div class="card">
    <h3 id="delete-title">Delete User</h3>
    <p id="delete-message">Are you sure you want to delete this user?</p>
    <div class="button-row">
      <button class="cancel-btn" onclick="closeOverlay('delete-overlay')">Cancel</button>
      <button class="confirm-btn" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>
<script>
  const tableBody = document.getElementById("user-table-body");
  const formOverlay = document.getElementById("form-overlay");
  const form = document.getElementById("user-form");
  const formTitle = document.getElementById("form-title");
  const submitBtn = form.querySelector(".submit-btn");

  let deleteTarget = null;

  // üîπ Fetch and render users
  async function fetchUsers() {
    try {
      const response = await fetch("/user/all", {
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${localStorage.getItem("token")}`,
        },
      });

      const data = await response.json();

      if (response.ok && data.success) {
        renderTable(data.users);
      } else {
        alert(data.error || "Failed to load users");
      }
    } catch (err) {
      console.error("Error fetching users:", err);
    }
  }

  function renderTable(users) {
    tableBody.innerHTML = "";
    users.forEach(user => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${user.id}</td>
        <td>${user.name}</td>
        <td>${user.email}</td>
        <td>${user.score}</td>
        <td>${user.results && user.results.length > 0 
            ? `<a href="userResult?id=${user.id}" class="btn small">Show</a>` 
            : `<span style="color:#888;">No Results</span>`}</td>
        <td>${user.admin ? "‚úîÔ∏è" : "‚ùå"}</td>
        <td><button class="icon-btn" onclick="openForm(${user.id}, '${user.name}', '${user.email}', ${user.score}, ${user.admin})"><i class="fa fa-pen"></i></button></td>
        <td><button class="icon-btn danger" onclick="openDelete(${user.id})"><i class="fa fa-trash"></i></button></td>
      `;
      tableBody.appendChild(row);
    });
  }

  // üîπ Open Add/Edit Form
  function openForm(id = null, name = "", email = "", score = 0, admin = false) {
    form.reset();
    if (id) {
      formTitle.textContent = "Edit User";
      submitBtn.textContent = "Update";
      form.id.value = id;
      form.name.value = name;
      form.email.value = email;
      form.score.value = score;
      form.admin.value = admin ? "true" : "false";
    } else {
      formTitle.textContent = "Add User";
      submitBtn.textContent = "Save";
      form.id.value = "";
    }
    formOverlay.style.display = "flex";
  }

  // üîπ Handle form submit (Add/Edit user)
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    const userData = {
      name: data.name,
      email: data.email,
      score: Number(data.score),
      admin: data.admin === "true"
    };

    try {
      let response;
      if (data.id) {
        response = await fetch(`/user/${data.id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
          body: JSON.stringify(userData),
        });
      } else {
        response = await fetch("/user/new", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
          body: JSON.stringify(userData),
        });
      }

      const result = await response.json();

      if (response.ok && result.success) {
        fetchUsers();
        closeOverlay("form-overlay");
      } else {
        alert(result.error || "Save failed");
      }
    } catch (err) {
      console.error("Error saving user:", err);
    }
  });

  // üîπ Delete confirmation
  function openDelete(id) {
    deleteTarget = id;
    document.getElementById("delete-overlay").style.display = "flex";
  }

  async function confirmDelete() {
    if (!deleteTarget) return;
    try {
      const response = await fetch(`/user/${deleteTarget}`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${localStorage.getItem("token")}`,
        },
      });

      const result = await response.json();

      if (response.ok && result.success) {
        fetchUsers();
        closeOverlay("delete-overlay");
        deleteTarget = null;
      } else {
        alert(result.error || "Delete failed");
      }
    } catch (err) {
      console.error("Error deleting user:", err);
    }
  }

  function closeOverlay(id) {
    document.getElementById(id).style.display = "none";
  }

  // Load users on page load
  fetchUsers();
</script>

</body>
</html>