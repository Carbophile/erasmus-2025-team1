<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>QuizBattle Admin</title>
		<link rel="stylesheet" href="../admin/css/users.css" />
		<link rel="stylesheet" href="../admin/css/general.css" />
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
		/>

	</head>
	<body>
		<aside class="sidebar">
			<div class="logo">QuizBattle</div>
			<nav>
				<a href="/admin/users" class="active"
					><i class="fa-solid fa-users"></i><span>Users</span></a
				>
				<a href="/admin/questions"
					><i class="fa-solid fa-question"></i><span>Questions</span></a
				>
				<a href="/admin/quizzes"
					><i class="fa-solid fa-file-circle-question"></i
					><span>Quizzes</span></a
				>
				<a href="/admin/categories"
					><i class="fa-solid fa-icons"></i><span>Categories</span></a
				>
			</nav>
		</aside>

		<div class="main">
			<header class="topbar">
				<div class="nav-left">
					<a href="../index.html"><button class="btn">Home</button></a>
					<a href="../leadeboard/lista.html"
						><button class="btn">Leaderboard</button></a
					>
				</div>
				<div class="search-box">
					<input type="text" placeholder="Search..." />
					<i class="fa fa-search"></i>
				</div>
				<div class="nav-right">
					<a href="../profil/profil.html"
						><i class="fa-solid fa-user user-icon"></i
					></a>
				</div>
			</header>

			<section class="table-section">
				<div class="table-header">
					<h2>Users</h2>
					<button class="btn add-btn" onclick="openAddForm()">
						<i class="fa fa-plus"></i> Add
					</button>
				</div>
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Id</th>
								<th>Name</th>
								<th>Email</th>
								<th>Score</th>
								<th>Results</th>
								<th>Admin</th>
								<th>Edit</th>
								<th>Delete</th>
							</tr>
						</thead>
						<tbody id="user-table-body"></tbody>
					</table>
				</div>
			</section>
		</div>

		<div class="overlay" id="add-user-overlay">
			<div class="card">
				<h3>Add User</h3>
				<form id="add-user-form">
					<div class="form-group">
						<label>Name</label>
						<input type="text" name="name" required />
					</div>
					<div class="form-group">
						<label>Email</label>
						<input type="email" name="email" required />
					</div>
					<div class="form-group">
						<label>Password</label>
						<input type="text" name="password" required />
					</div>
					<div class="form-group">
						<label>Admin</label>
						<select name="admin">
							<option value="true">Yes</option>
							<option value="false">No</option>
						</select>
					</div>
					<button type="submit" class="submit-btn">Save</button>
				</form>
				<button class="close-btn" onclick="closeOverlay('add-user-overlay')">
					Close
				</button>
			</div>
		</div>

		<div class="overlay" id="edit-user-overlay">
			<div class="card">
				<h3>Edit User</h3>
				<form id="edit-user-form">
					<input type="hidden" name="id" />
					<input type="hidden" name="password" />
					<div class="form-group">
						<label>Name</label>
						<input type="text" name="name" required />
					</div>
					<div class="form-group">
						<label>Email</label>
						<input type="email" name="email" required />
					</div>
					<div class="form-group">
						<label>Password</label>
						<button type="button" class="reset-btn" onclick="resetPassword()">
							Reset Password
						</button>
					</div>
					<div class="form-group">
						<label>Admin</label>
						<select name="admin">
							<option value="true">Yes</option>
							<option value="false">No</option>
						</select>
					</div>
					<button type="submit" class="submit-btn">Update</button>
				</form>
				<button class="close-btn" onclick="closeOverlay('edit-user-overlay')">
					Close
				</button>
			</div>
		</div>

		<div class="overlay" id="delete-overlay">
			<div class="card">
				<h3>Delete User</h3>
				<p>Are you sure you want to delete this user?</p>
				<div class="button-row">
					<button class="cancel-btn" onclick="closeOverlay('delete-overlay')">
						Cancel
					</button>
					<button class="confirm-btn" onclick="confirmDelete()">Delete</button>
				</div>
			</div>
		</div>

		<script>
			document.addEventListener("DOMContentLoaded", async () => {
				const token = localStorage.getItem("token");
				if (!token) return (window.location.href = "../login/index.html");

				const tableBody = document.getElementById("user-table-body");
				let deleteTarget = null;

				async function fetchUsers() {
					try {
						const response = await fetch("/users", {
							headers: {
								"Content-Type": "application/json",
								Authorization: `Bearer ${token}`,
							},
						});
						const data = await response.json();
						if (data.success) renderTable(data.users);
						else alert(data.error || "Failed to load users");
					} catch (err) {
						console.error(err);
					}
				}

				function renderTable(users) {
					tableBody.innerHTML = "";
					users.forEach((user) => {
						const row = document.createElement("tr");
						row.innerHTML = `
        <td>${user.id}</td>
        <td>${user.name}</td>
        <td>${user.email}</td>
        <td>${user.score || "0"}</td>
        <td><a class="btn small" href="./userResult.html?id=${
					user.id
				}">Show<i class="fa fa-solid fa-eye "></i></a></td>
        <td>${user.is_admin ? "✔️" : "❌"}</td>
        <td><button class="icon-btn" onclick='openEditForm(${JSON.stringify(
					user
				)})'><i class="fa fa-pen"></i></button></td>
        <td><button class="icon-btn danger" onclick="openDelete(${
					user.id
				})"><i class="fa fa-trash"></i></button></td>
      `;
						tableBody.appendChild(row);
					});
				}

				window.openAddForm = () => {
					document.getElementById("add-user-form").reset();
					document.getElementById("add-user-overlay").style.display = "flex";
				};

				window.openEditForm = (user) => {
					const form = document.getElementById("edit-user-form");
					form.reset();
					form.id.value = user.id;
					form.name.value = user.name;
					form.email.value = user.email;
					form.admin.value = user.is_admin ? "true" : "false";
					form.password.value = user.password || ""; 
					document.getElementById("edit-user-overlay").style.display = "flex";
				};

				window.closeOverlay = (id) =>
					(document.getElementById(id).style.display = "none");

				window.resetPassword = () => alert("Password reset not implemented.");

				document
					.getElementById("add-user-form")
					.addEventListener("submit", async (e) => {
						e.preventDefault();
						const data = Object.fromEntries(new FormData(e.target).entries());
						const payload = {
							name: data.name,
							email: data.email,
							password: data.password,
							is_admin: data.admin === "true",
						};
						try {
							const res = await fetch("/user/new", {
								method: "POST",
								headers: {
									"Content-Type": "application/json",
									Authorization: `Bearer ${token}`,
								},
								body: JSON.stringify(payload),
							});
							const result = await res.json();
							if (result.success) {
								fetchUsers();
								closeOverlay("add-user-overlay");
							} else alert(result.error || "Add failed");
						} catch (err) {
							console.error(err);
						}
					});

				document
					.getElementById("edit-user-form")
					.addEventListener("submit", async (e) => {
						e.preventDefault();
						const data = Object.fromEntries(new FormData(e.target).entries());
						const payload = {
							id: data.id,
							name: data.name,
							email: data.email,
							is_admin: data.admin === "true",
						};
						if (data.password) payload.password = data.password;
						try {
							const res = await fetch("/user", {
								method: "PATCH",
								headers: {
									"Content-Type": "application/json",
									Authorization: `Bearer ${token}`,
								},
								body: JSON.stringify(payload),
							});
							const result = await res.json();
							if (result.success) {
								fetchUsers();
								closeOverlay("edit-user-overlay");
							} else alert(result.error || "Update failed");
						} catch (err) {
							console.error(err);
						}
					});

				window.openDelete = (id) => {
					deleteTarget = id;
					document.getElementById("delete-overlay").style.display = "flex";
				};
				window.confirmDelete = async () => {
					if (!deleteTarget) return;
					try {
						const res = await fetch("/user", {
							method: "DELETE",
							headers: {
								"Content-Type": "application/json",
								Authorization: `Bearer ${token}`,
							},
							body: JSON.stringify({ id: deleteTarget }),
						});
						const result = await res.json();

						if (result.success) {
							fetchUsers();
							closeOverlay("delete-overlay");
							deleteTarget = null;
						} else alert(result.error || "Delete failed");
					} catch (err) {
						console.error(err);
					}
				};

				fetchUsers();
			});
		</script>
	</body>
</html>
